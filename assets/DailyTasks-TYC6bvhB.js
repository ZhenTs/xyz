import{d as ie,c as v,o as g,a as s,u as Y,r as b,G as Z,i as x,h as n,t as f,p as N,w as i,m as p,j as R,l as w,F as K,n as H,k as Q,b as ce,e as re,A as j,g as de,v as ue}from"./index-B2ntl-FI.js";import{_ as ee}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{S as X}from"./Settings-C_A4IUmv.js";import{C as me,b as ge,a as ve}from"./Time-l48mO-LN.js";import{R as ke}from"./Refresh-hxtgiIzy.js";import{S as fe}from"./Search-BOqnsqUz.js";const pe={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 512 512"},_e=s("path",{fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"32",d:"M416 128L192 384l-96-96"},null,-1),he=[_e],we=ie({name:"Checkmark",render:function(I,m){return g(),v("svg",pe,he)}}),ye={class:"card-header"},xe={class:"header-left"},Se=["src","alt"],be={class:"title-container"},$e={class:"title"},Te={key:0,class:"subtitle"},Ce={class:"header-right"},Re={key:0,class:"progress-container"},De={class:"info-container"},Ee={class:"info-item"},We={class:"info-value"},Oe={key:0,class:"info-item"},Ue={class:"info-value"},Ae={key:1,class:"info-item"},Le={class:"info-value"},Ne={key:1,class:"actions-container"},Ie={class:"modal-header"},Pe={class:"settings-content"},ze={class:"settings-grid"},Be={class:"setting-item"},Me={class:"setting-item"},Fe={class:"setting-item"},Ve={key:0,class:"task-details"},je={class:"task-list"},Ge={class:"task-item-left"},Je={class:"task-name"},qe={key:1,class:"execution-log"},Ke={class:"log-container"},He={class:"log-time"},Qe={__name:"DailyTaskCard",props:{task:{type:Object,required:!0}},emits:["update:task","execute","toggle-status"],setup(c,{emit:I}){var L,P,z;const m=c,D=I,h=Y(),$=b(!1),S=b(!1),l=b({autoExecute:((L=m.task.settings)==null?void 0:L.autoExecute)||!1,delay:((P=m.task.settings)==null?void 0:P.delay)||0,notification:((z=m.task.settings)==null?void 0:z.notification)||!0}),W=()=>S.value?"执行中...":m.task.canExecute?"立即执行":"不可执行",E=()=>{D("toggle-status",m.task.id)},r=async()=>{if(!(S.value||!m.task.canExecute))try{S.value=!0,await D("execute",m.task.id),l.value.notification&&h.success(`任务 "${m.task.title}" 执行成功`)}catch(k){h.error(`任务执行失败: ${k.message}`)}finally{S.value=!1}},U=(k,a)=>{l.value[k]=a,D("update:task",{...m.task,settings:{...l.value}})},G=k=>new Date(k).toLocaleString("zh-CN",{month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}),A=k=>new Date(k).toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit",second:"2-digit"});return Z(()=>m.task.settings,k=>{k&&(l.value={...l.value,...k})},{immediate:!0}),(k,a)=>{const O=p("n-icon"),B=p("n-button"),M=p("n-checkbox"),F=p("n-input-number"),J=p("n-modal");return g(),v("div",{class:N(["daily-task-card",{completed:c.task.completed}])},[s("div",ye,[s("div",xe,[s("img",{src:c.task.icon||"/icons/ta.png",alt:c.task.title,class:"task-icon"},null,8,Se),s("div",be,[s("h3",$e,f(c.task.title),1),c.task.subtitle?(g(),v("p",Te,f(c.task.subtitle),1)):x("",!0)])]),s("div",Ce,[s("div",{class:N(["status-indicator",{completed:c.task.completed}]),onClick:E},[s("span",{class:N(["status-dot",{completed:c.task.completed}])},null,2),s("span",null,f(c.task.completed?"已完成":"待完成"),1)],2),n(B,{text:"",class:"settings-button",onClick:a[0]||(a[0]=d=>$.value=!0)},{icon:i(()=>[n(O,{class:"settings-icon"},{default:i(()=>[n(R(X))]),_:1})]),_:1})])]),c.task.progress?(g(),v("div",Re,[s("div",De,[s("div",Ee,[a[8]||(a[8]=s("span",{class:"info-label"},"当前进度",-1)),s("span",We,f(c.task.progress.current)+"/"+f(c.task.progress.total),1)]),c.task.reward?(g(),v("div",Oe,[a[9]||(a[9]=s("span",{class:"info-label"},"奖励",-1)),s("span",Ue,f(c.task.reward),1)])):x("",!0),c.task.nextReset?(g(),v("div",Ae,[a[10]||(a[10]=s("span",{class:"info-label"},"重置时间",-1)),s("span",Le,f(G(c.task.nextReset)),1)])):x("",!0)])])):x("",!0),c.task.completed?x("",!0):(g(),v("div",Ne,[n(B,{type:"primary",block:"",loading:S.value,disabled:!c.task.canExecute,class:"complete-button",onClick:r},{default:i(()=>[w(f(W()),1)]),_:1},8,["loading","disabled"])])),n(J,{show:$.value,"onUpdate:show":a[7]||(a[7]=d=>$.value=d),preset:"card",title:"任务设置",style:{width:"480px"}},{header:i(()=>[s("div",Ie,[n(O,{class:"modal-icon"},{default:i(()=>[n(R(X))]),_:1}),s("span",null,f(c.task.title)+" - 设置",1)])]),default:i(()=>[s("div",Pe,[s("div",ze,[s("div",Be,[n(M,{checked:l.value.autoExecute,"onUpdate:checked":[a[1]||(a[1]=d=>l.value.autoExecute=d),a[2]||(a[2]=d=>U("autoExecute",d))]},{default:i(()=>[...a[11]||(a[11]=[w(" 自动执行 ",-1)])]),_:1},8,["checked"])]),s("div",Me,[a[12]||(a[12]=s("label",{class:"setting-label"},"执行延迟 (秒)",-1)),n(F,{value:l.value.delay,"onUpdate:value":[a[3]||(a[3]=d=>l.value.delay=d),a[4]||(a[4]=d=>U("delay",d))],min:0,max:300},null,8,["value"])]),s("div",Fe,[n(M,{checked:l.value.notification,"onUpdate:checked":[a[5]||(a[5]=d=>l.value.notification=d),a[6]||(a[6]=d=>U("notification",d))]},{default:i(()=>[...a[13]||(a[13]=[w(" 完成通知 ",-1)])]),_:1},8,["checked"])])]),c.task.details?(g(),v("div",Ve,[a[14]||(a[14]=s("h4",null,"任务详情",-1)),s("div",je,[(g(!0),v(K,null,H(c.task.details,d=>(g(),v("div",{key:d.id,class:"task-item"},[s("div",Ge,[n(O,{class:N(["task-status-icon",{completed:d.completed}])},{default:i(()=>[d.completed?(g(),Q(R(we),{key:0})):(g(),Q(R(me),{key:1}))]),_:2},1032,["class"]),s("span",Je,f(d.name),1)])]))),128))])])):x("",!0),c.task.logs&&c.task.logs.length?(g(),v("div",qe,[a[15]||(a[15]=s("h4",null,"执行日志",-1)),s("div",Ke,[(g(!0),v(K,null,H(c.task.logs.slice(-5),d=>(g(),v("div",{key:d.id,class:"log-item"},[s("span",He,f(A(d.timestamp)),1),s("span",{class:N(["log-message",{error:d.type==="error",success:d.type==="success"}])},f(d.message),3)]))),128))])])):x("",!0)])]),_:1},8,["show"])],2)}}},Xe=ee(Qe,[["__scopeId","data-v-6ba0540f"]]),Ye={class:"daily-tasks-page"},Ze={class:"page-header"},et={class:"container"},tt={class:"header-content"},st={class:"header-actions"},ot={class:"role-selector-section"},at={class:"container"},nt={class:"role-selector"},lt={key:0,class:"role-stats"},it={class:"stat-item"},ct={class:"stat-value"},rt={class:"stat-item"},dt={class:"stat-value"},ut={class:"stat-item"},mt={class:"stat-value"},gt={class:"filter-section"},vt={class:"container"},kt={class:"filter-bar"},ft={class:"search-box"},pt={class:"tasks-section"},_t={class:"container"},ht={key:0,class:"tasks-grid"},wt={key:1,class:"empty-state"},yt={key:2,class:"loading-state"},xt={__name:"DailyTasks",setup(c){const I=ue(),m=Y(),D=ce(),h=re(),$=b(!1),S=b(!1),l=b(null),W=b("all"),E=b(""),r=b([]),U=j(()=>gameRolesStore.gameRoles.find(t=>t.id===l.value)),G=j(()=>gameRolesStore.gameRoles.map(t=>({label:`${t.name} (${t.server})`,value:t.id}))),A=j(()=>{const t=r.value.length,e=r.value.filter(u=>u.completed).length,o=t>0?Math.round(e/t*100):0;return{total:t,completed:e,percentage:o}}),L=j(()=>{let t=r.value;switch(W.value){case"pending":t=t.filter(e=>!e.completed);break;case"completed":t=t.filter(e=>e.completed);break;case"auto":t=t.filter(e=>{var o;return(o=e.settings)==null?void 0:o.autoExecute});break}if(E.value){const e=E.value.toLowerCase();t=t.filter(o=>{var u;return o.title.toLowerCase().includes(e)||((u=o.subtitle)==null?void 0:u.toLowerCase().includes(e))})}return t}),P=[{label:"执行所有待完成任务",key:"execute-all-pending"},{label:"标记所有为已完成",key:"mark-all-completed"},{label:"重置所有任务状态",key:"reset-all-tasks"}],z=async(t,e=3,o=2e3)=>{console.log("每日页面进入，开始检查WebSocket连接状态...");for(let u=1;u<=e;u++)try{const y=h.getWebSocketStatus(t);if(console.log(`第${u}次检查，WebSocket状态:`,y),y!=="connected"){console.log("WebSocket未连接，尝试建立连接...");const _=h.gameTokens.find(V=>V.id===t);if(_&&_.token){if(h.createWebSocketConnection(t,_.token,_.wsUrl),await new Promise(q=>setTimeout(q,o)),h.getWebSocketStatus(t)!=="connected")if(u<e){console.log(`连接未建立，${o/1e3}秒后重试...`);continue}else throw new Error("WebSocket连接超时")}else throw new Error("未找到有效的Token数据或WebSocket URL")}console.log("WebSocket已连接，开始加载阵容数据...");const T=await h.sendMessageWithPromise(t,"presetteam_getinfo",{},8e3);if(T)return h.$patch(_=>{_.gameData={..._.gameData??{},presetTeam:T}}),console.log("阵容数据加载成功:",T),m.success("阵容数据已更新"),T}catch(y){if(console.error(`第${u}次尝试失败:`,y),u<e)console.log(`${o/1e3}秒后进行第${u+1}次重试...`),await new Promise(T=>setTimeout(T,o));else return console.error("所有重试均失败，阵容数据加载失败"),m.warning(`阵容数据加载失败: ${y.message||"未知错误"}`),null}},k=async()=>{if(!l.value){m.warning("请先选择游戏角色");return}try{S.value=!0,$.value=!0;const t=a(l.value);r.value=t,localStorage.setItem(`dailyTasks_${l.value}`,JSON.stringify(t)),m.success("任务数据刷新成功")}catch(t){console.error("刷新任务失败:",t),m.error("本地数据生成失败")}finally{S.value=!1,$.value=!1}},a=t=>{const e=gameRolesStore.gameRoles.find(o=>o.id===t);return e!=null&&e.name,[{id:`task_${t}_daily_signin`,title:"每日签到",subtitle:"登录游戏获取签到奖励",icon:"/icons/ta.png",completed:!1,canExecute:!0,progress:{current:0,total:1},reward:"金币 x100, 经验 x50",nextReset:new Date(Date.now()+24*60*60*1e3).toISOString(),settings:{autoExecute:!1,delay:0,notification:!0},details:[{id:1,name:"打开游戏客户端",completed:!1},{id:2,name:"点击签到按钮",completed:!1}],logs:[]},{id:`task_${t}_daily_quest`,title:"完成日常任务",subtitle:"完成5个日常任务获得奖励",icon:"/icons/ta.png",completed:!1,canExecute:!0,progress:{current:2,total:5},reward:"金币 x500, 装备碎片 x10",nextReset:new Date(Date.now()+24*60*60*1e3).toISOString(),settings:{autoExecute:!0,delay:5,notification:!0},details:[{id:1,name:"击败10只怪物",completed:!0},{id:2,name:"收集20个材料",completed:!0},{id:3,name:"完成一次副本",completed:!1},{id:4,name:"参与公会活动",completed:!1},{id:5,name:"强化装备",completed:!1}],logs:[{id:1,timestamp:Date.now()-30*60*1e3,type:"success",message:"已完成击败怪物任务"},{id:2,timestamp:Date.now()-60*60*1e3,type:"success",message:"已完成材料收集任务"}]},{id:`task_${t}_guild_contribution`,title:"公会贡献",subtitle:"为公会贡献资源获得贡献点",icon:"/icons/ta.png",completed:!0,canExecute:!1,progress:{current:1,total:1},reward:"公会贡献点 x100",nextReset:new Date(Date.now()+24*60*60*1e3).toISOString(),settings:{autoExecute:!0,delay:0,notification:!0},details:[{id:1,name:"捐献金币",completed:!0}],logs:[{id:1,timestamp:Date.now()-2*60*60*1e3,type:"success",message:"已完成公会贡献"}]}]},O=t=>{l.value=t,gameRolesStore.selectRole(gameRolesStore.gameRoles.find(e=>e.id===t)),t&&k()},B=t=>{W.value=t},M=t=>{E.value=t},F=async t=>{if(!l.value){m.error("请先选择游戏角色");return}try{if(localTokenStore.getWebSocketStatus(l.value)!=="connected"){const u=localTokenStore.getGameToken(l.value);if(u)localTokenStore.createWebSocketConnection(l.value,u.token,u.wsUrl),await new Promise(y=>setTimeout(y,1e3));else throw new Error("未找到游戏token，请重新添加角色")}console.log(`通过WebSocket执行任务: ${t}`);const o=r.value.findIndex(u=>u.id===t);o!==-1&&(r.value[o]={...r.value[o],completed:!0,completedAt:new Date().toISOString()},r.value[o].logs||(r.value[o].logs=[]),r.value[o].logs.push({id:Date.now(),timestamp:Date.now(),type:"success",message:`任务 "${r.value[o].title}" 执行成功`}),localStorage.setItem(`dailyTasks_${l.value}`,JSON.stringify(r.value))),m.success("任务执行成功")}catch(e){console.error("执行任务失败:",e);const o=r.value.findIndex(u=>u.id===t);throw o!==-1&&(r.value[o].logs||(r.value[o].logs=[]),r.value[o].logs.push({id:Date.now(),timestamp:Date.now(),type:"error",message:`任务执行失败: ${e.message}`})),e}},J=t=>{const e=r.value.findIndex(o=>o.id===t);e!==-1&&(r.value[e].completed=!r.value[e].completed,m.info("任务状态已更新"))},d=t=>{const e=r.value.findIndex(o=>o.id===t.id);e!==-1&&(r.value[e]=t)},te=t=>{switch(t){case"execute-all-pending":se();break;case"mark-all-completed":oe();break;case"reset-all-tasks":ae();break}},se=async()=>{const t=r.value.filter(e=>!e.completed&&e.canExecute);if(t.length===0){m.info("没有可执行的待完成任务");return}D.confirm({title:"批量执行任务",content:`确定要执行 ${t.length} 个待完成任务吗？`,positiveText:"确定",negativeText:"取消",onPositiveClick:async()=>{let e=0,o=0;for(const u of t)try{await F(u.id),e++}catch{o++}m.info(`批量执行完成：成功 ${e} 个，失败 ${o} 个`)}})},oe=()=>{const t=r.value.filter(e=>!e.completed);if(t.length===0){m.info("所有任务都已完成");return}D.confirm({title:"标记所有任务为已完成",content:`确定要将 ${t.length} 个待完成任务标记为已完成吗？`,positiveText:"确定",negativeText:"取消",onPositiveClick:()=>{t.forEach(e=>{e.completed=!0,e.completedAt=new Date().toISOString()}),m.success("所有任务已标记为完成")}})},ae=()=>{D.confirm({title:"重置所有任务状态",content:"确定要重置所有任务状态吗？此操作将清除所有完成记录。",positiveText:"确定",negativeText:"取消",onPositiveClick:()=>{r.value.forEach(t=>{t.completed=!1,t.completedAt=null}),m.success("所有任务状态已重置")}})};return de(async()=>{if(!authStore.isAuthenticated){I.push("/login");return}if(gameRolesStore.gameRoles.length===0&&await gameRolesStore.fetchGameRoles(),h.selectedToken&&await z(h.selectedToken.id),gameRolesStore.selectedRole){l.value=gameRolesStore.selectedRole.id;const t=localStorage.getItem(`dailyTasks_${l.value}`);if(t)try{r.value=JSON.parse(t)}catch(e){console.error("解析任务数据失败:",e),k()}else k()}else gameRolesStore.gameRoles.length>0&&(l.value=gameRolesStore.gameRoles[0].id,O(l.value))}),Z(()=>gameRolesStore.selectedRole,t=>{t&&t.id!==l.value&&(l.value=t.id)}),(t,e)=>{const o=p("n-icon"),u=p("n-button"),y=p("n-dropdown"),T=p("n-select"),_=p("n-radio-button"),V=p("n-radio-group"),q=p("n-input"),ne=p("n-empty"),le=p("n-spin");return g(),v("div",Ye,[s("div",Ze,[s("div",et,[s("div",tt,[e[5]||(e[5]=s("div",{class:"header-left"},[s("h1",{class:"page-title"}," 日常任务 "),s("p",{class:"page-subtitle"}," 管理和执行您的日常游戏任务 ")],-1)),s("div",st,[n(u,{type:"primary",size:"large",loading:S.value,onClick:k},{icon:i(()=>[n(o,null,{default:i(()=>[n(R(ke))]),_:1})]),default:i(()=>[e[3]||(e[3]=w(" 刷新任务 ",-1))]),_:1},8,["loading"]),n(y,{options:P,onSelect:te},{default:i(()=>[n(u,{size:"large"},{icon:i(()=>[n(o,null,{default:i(()=>[n(R(ge))]),_:1})]),default:i(()=>[e[4]||(e[4]=w(" 批量操作 ",-1))]),_:1})]),_:1})])])])]),s("div",ot,[s("div",at,[s("div",nt,[e[9]||(e[9]=s("span",{class:"selector-label"},"选择角色：",-1)),n(T,{value:l.value,"onUpdate:value":[e[0]||(e[0]=C=>l.value=C),O],options:G.value,placeholder:"请选择游戏角色",style:{"min-width":"200px"}},null,8,["value","options"]),U.value?(g(),v("div",lt,[s("div",it,[e[6]||(e[6]=s("span",{class:"stat-label"},"总任务：",-1)),s("span",ct,f(A.value.total),1)]),s("div",rt,[e[7]||(e[7]=s("span",{class:"stat-label"},"已完成：",-1)),s("span",dt,f(A.value.completed),1)]),s("div",ut,[e[8]||(e[8]=s("span",{class:"stat-label"},"进度：",-1)),s("span",mt,f(A.value.percentage)+"%",1)])])):x("",!0)])])]),s("div",gt,[s("div",vt,[s("div",kt,[n(V,{value:W.value,"onUpdate:value":[e[1]||(e[1]=C=>W.value=C),B]},{default:i(()=>[n(_,{value:"all"},{default:i(()=>[...e[10]||(e[10]=[w(" 全部任务 ",-1)])]),_:1}),n(_,{value:"pending"},{default:i(()=>[...e[11]||(e[11]=[w(" 待完成 ",-1)])]),_:1}),n(_,{value:"completed"},{default:i(()=>[...e[12]||(e[12]=[w(" 已完成 ",-1)])]),_:1}),n(_,{value:"auto"},{default:i(()=>[...e[13]||(e[13]=[w(" 自动执行 ",-1)])]),_:1})]),_:1},8,["value"]),s("div",ft,[n(q,{value:E.value,"onUpdate:value":[e[2]||(e[2]=C=>E.value=C),M],placeholder:"搜索任务...",clearable:""},{prefix:i(()=>[n(o,null,{default:i(()=>[n(R(fe))]),_:1})]),_:1},8,["value"])])])])]),s("div",pt,[s("div",_t,[L.value.length?(g(),v("div",ht,[(g(!0),v(K,null,H(L.value,C=>(g(),Q(Xe,{key:C.id,task:C,onExecute:F,onToggleStatus:J,"onUpdate:task":d},null,8,["task"]))),128))])):$.value?x("",!0):(g(),v("div",wt,[n(ne,{description:"暂无任务数据",size:"large"},{icon:i(()=>[n(o,null,{default:i(()=>[n(R(ve))]),_:1})]),extra:i(()=>[n(u,{type:"primary",onClick:k},{default:i(()=>[...e[14]||(e[14]=[w(" 刷新任务 ",-1)])]),_:1})]),_:1})])),$.value?(g(),v("div",yt,[n(le,{size:"large"},{description:i(()=>[...e[15]||(e[15]=[w(" 正在加载任务数据... ",-1)])]),_:1})])):x("",!0)])])])}}},Dt=ee(xt,[["__scopeId","data-v-ff9723c8"]]);export{Dt as default};
