import{d as ee,c as y,o as m,a as n,u as Re,b as $e,e as Ee,r as C,f as N,g as We,h as t,i as T,j as a,k as S,l as v,w as o,N as f,m as w,t as x,F as Le,n as Me,p as K,q as X,s as h,v as ze}from"./index-B2ntl-FI.js";import{_ as Fe}from"./xiaoyugan-Dwisk7G8.js";import{T as je,A as Y}from"./ThemeToggle-DbyMvUsb.js";import{_ as Ae}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{S as Be,T as Ie,C as Oe,E as Ne}from"./TrashBin-bVr5yFjC.js";import{R as Z}from"./Refresh-hxtgiIzy.js";import{C as Q}from"./CloudUpload-DY82Mkvt.js";import{H as He}from"./Home-v78Briev.js";import{M as qe,K as De}from"./Menu-DOWsDjii.js";const Ve={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 512 512"},Je=n("path",{d:"M408 480H184a72 72 0 0 1-72-72V184a72 72 0 0 1 72-72h224a72 72 0 0 1 72 72v224a72 72 0 0 1-72 72z",fill:"currentColor"},null,-1),Pe=n("path",{d:"M160 80h235.88A72.12 72.12 0 0 0 328 32H104a72 72 0 0 0-72 72v224a72.12 72.12 0 0 0 48 67.88V160a80 80 0 0 1 80-80z",fill:"currentColor"},null,-1),Ge=[Je,Pe],Ke=ee({name:"Copy",render:function(F,i){return m(),y("svg",Ve,Ge)}}),Xe={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 512 512"},Ye=n("path",{d:"M200.66 352H144a96 96 0 0 1 0-192h55.41",fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"48"},null,-1),Ze=n("path",{d:"M312.59 160H368a96 96 0 0 1 0 192h-56.66",fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"48"},null,-1),Qe=n("path",{fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"48",d:"M169.07 256h175.86"},null,-1),es=[Ye,Ze,Qe],ss=ee({name:"Link",render:function(F,i){return m(),y("svg",Xe,es)}}),ts={class:"token-import-page"},os={class:"container"},ls={class:"page-header"},ns={class:"header-content"},rs={class:"header-top"},as={key:0,class:"import-section"},is={class:"import-card"},cs={class:"card-header"},us={class:"optional-fields"},ds={class:"form-actions"},ps={class:"optional-fields"},ms={class:"form-actions"},ks={key:1,class:"tokens-section"},vs={class:"section-header"},fs={class:"header-actions"},_s={class:"tokens-grid"},Ts=["onClick"],hs={class:"card-header"},gs={class:"token-info"},bs={class:"token-name"},ws={class:"token-meta"},ys={key:0,class:"meta-item"},Us={class:"card-actions"},Cs={class:"card-body"},xs={class:"token-display"},Ss={class:"token-value"},Rs={class:"connection-status"},$s={class:"status-indicator"},Es={class:"status-text"},Ws={class:"connection-actions"},Ls={class:"token-timestamps"},Ms={class:"timestamp-item"},zs={class:"timestamp-value"},Fs={class:"timestamp-item"},js={class:"timestamp-value"},As={key:0,class:"card-footer"},Bs={key:2,class:"empty-state"},Is={class:"modal-actions"},Os={__name:"TokenImport",setup(H){const F=ze(),i=Re(),q=$e(),r=Ee(),U=C(!1),R=C(!1),W=C(!1),j=C(null),A=C(null),B=C(null),L=C(null),M=C("manual"),I=C(new Set),k=N({name:"",base64Token:"",server:"",wsUrl:""}),u=N({name:"",url:"",server:"",wsUrl:""}),g=N({name:"",server:"",wsUrl:""}),se={name:[{required:!0,message:"请输入Token名称",trigger:"blur"}],base64Token:[{required:!0,message:"请输入Base64 Token",trigger:"blur"}]},te={name:[{required:!0,message:"请输入Token名称",trigger:"blur"}],url:[{required:!0,message:"请输入Token获取地址",trigger:"blur"},{type:"url",message:"请输入有效的URL地址",trigger:"blur"}]},oe={name:[{required:!0,message:"请输入Token名称",trigger:"blur"}]},le=[{label:"导出所有Token",key:"export"},{label:"导入Token文件",key:"import"},{label:"清理过期Token",key:"clean"},{label:"断开所有连接",key:"disconnect"},{label:"清除所有Token",key:"clear"}],ne=async()=>{var s;if(j.value)try{await j.value.validate(),R.value=!0;const e=r.importBase64Token(k.name,k.base64Token,{server:k.server,wsUrl:k.wsUrl,importMethod:"manual"});if(e.success)i.success(e.message),e.details&&console.log("Token导入详情:",e.details),ae(),U.value=!1;else{const b=e.error||e.message||"Token导入失败";i.error(b),console.error("Token导入错误详情:",{error:e.error,message:e.message,originalToken:((s=k.base64Token)==null?void 0:s.substring(0,50))+"..."})}}catch{}finally{R.value=!1}},re=async()=>{var s;if(A.value)try{await A.value.validate(),R.value=!0;let e;if(u.url.startsWith(window.location.origin)||u.url.startsWith("/")||u.url.startsWith("http://localhost")||u.url.startsWith("http://127.0.0.1"))e=await fetch(u.url);else try{e=await fetch(u.url,{method:"GET",headers:{Accept:"application/json"},mode:"cors"})}catch(p){throw new Error(`跨域请求被阻止。请确保目标服务器支持CORS，或使用浏览器扩展/代理服务器。错误详情: ${p.message}`)}if(!e.ok)throw new Error(`请求失败: ${e.status} ${e.statusText}`);const d=await e.json();if(!d.token)throw new Error("返回数据中未找到token字段");const c=r.importBase64Token(u.name,d.token,{server:u.server||d.server,wsUrl:u.wsUrl,sourceUrl:u.url,importMethod:"url"});if(c.success)i.success(c.message),c.details&&console.log("URL Token导入详情:",c.details),ie(),U.value=!1;else{const p=c.error||c.message||"URL Token导入失败";i.error(p),console.error("URL Token导入错误详情:",{error:c.error,message:c.message,sourceUrl:u.url,receivedToken:((s=d==null?void 0:d.token)==null?void 0:s.substring(0,50))+"..."})}}catch(e){console.error("URL获取Token失败:",e),i.error(e.message||"URL获取Token失败")}finally{R.value=!1}},D=async s=>{if(!s.sourceUrl){i.warning("该Token未配置刷新地址");return}I.value.add(s.id);try{let e;if(s.sourceUrl.startsWith(window.location.origin)||s.sourceUrl.startsWith("/")||s.sourceUrl.startsWith("http://localhost")||s.sourceUrl.startsWith("http://127.0.0.1"))e=await fetch(s.sourceUrl);else try{e=await fetch(s.sourceUrl,{method:"GET",headers:{Accept:"application/json"},mode:"cors"})}catch(c){throw new Error(`跨域请求被阻止。请确保目标服务器支持CORS。错误详情: ${c.message}`)}if(!e.ok)throw new Error(`请求失败: ${e.status} ${e.statusText}`);const d=await e.json();if(!d.token)throw new Error("返回数据中未找到token字段");r.updateToken(s.id,{token:d.token,server:d.server||s.server,lastRefreshed:Date.now()}),r.getWebSocketStatus(s.id)==="connected"&&(r.closeWebSocketConnection(s.id),setTimeout(()=>{r.createWebSocketConnection(s.id,d.token,s.wsUrl)},500)),i.success("Token刷新成功")}catch(e){console.error("刷新Token失败:",e),i.error(e.message||"Token刷新失败")}finally{I.value.delete(s.id)}},ae=()=>{Object.keys(k).forEach(s=>{k[s]=""})},ie=()=>{Object.keys(u).forEach(s=>{u[s]=""})},ce=s=>{r.selectToken(s.id),i.success(`已选择：${s.name}`)},$=s=>r.getWebSocketStatus(s),ue=s=>{switch($(s)){case"connected":return"已连接";case"connecting":return"连接中";case"error":return"连接错误";default:return"未连接"}},de=s=>{$(s.id)==="connected"?(r.closeWebSocketConnection(s.id),i.info("WebSocket连接已断开")):(r.createWebSocketConnection(s.id,s.token,s.wsUrl),i.success("正在建立WebSocket连接..."))},pe=s=>{const e=[{label:"编辑",key:"edit",icon:()=>h(f,null,{default:()=>h(Oe)})},{label:"复制Token",key:"copy",icon:()=>h(f,null,{default:()=>h(Ke)})}];return s.importMethod==="url"&&s.sourceUrl?e.push({label:"从URL刷新",key:"refresh-url",icon:()=>h(f,null,{default:()=>h(Be)})}):e.push({label:"刷新Token",key:"refresh",icon:()=>h(f,null,{default:()=>h(Z)})}),e.push({label:"重新连接",key:"reconnect",icon:()=>h(f,null,{default:()=>h(ss)})},{type:"divider"},{label:"删除",key:"delete",icon:()=>h(f,null,{default:()=>h(Ie)}),props:{style:{color:"#e74c3c"}}}),e},me=async(s,e)=>{switch(s){case"edit":ke(e);break;case"copy":fe(e);break;case"refresh":i.info("手动添加的Token暂不支持刷新，请重新导入");break;case"refresh-url":D(e);break;case"reconnect":_e(e);break;case"delete":Te(e);break}},ke=s=>{L.value=s,Object.assign(g,{name:s.name,server:s.server||"",wsUrl:s.wsUrl||""}),W.value=!0},ve=async()=>{if(!(!B.value||!L.value))try{await B.value.validate(),r.updateToken(L.value.id,{name:g.name,server:g.server,wsUrl:g.wsUrl}),i.success("Token信息已更新"),W.value=!1,L.value=null}catch{}},fe=async s=>{try{await navigator.clipboard.writeText(s.token),i.success("Token已复制到剪贴板")}catch{i.error("复制失败")}},_e=s=>{r.closeWebSocketConnection(s.id),setTimeout(()=>{r.createWebSocketConnection(s.id,s.token,s.wsUrl),i.success("正在重新连接...")},500)},Te=s=>{q.warning({title:"删除Token",content:`确定要删除Token "${s.name}" 吗？此操作无法恢复。`,positiveText:"确定删除",negativeText:"取消",onPositiveClick:()=>{r.removeToken(s.id),i.success("Token已删除")}})},he=s=>{switch(s){case"export":ge();break;case"import":be();break;case"clean":we();break;case"disconnect":ye();break;case"clear":Ue();break}},ge=()=>{try{const s=r.exportTokens(),e=JSON.stringify(s,null,2),b=new Blob([e],{type:"application/json"}),d=document.createElement("a");d.href=URL.createObjectURL(b),d.download=`tokens_backup_${new Date().toISOString().split("T")[0]}.json`,d.click(),i.success("Token数据已导出")}catch{i.error("导出失败")}},be=()=>{const s=document.createElement("input");s.type="file",s.accept=".json",s.onchange=e=>{const b=e.target.files[0];if(b){const d=new FileReader;d.onload=c=>{try{const p=JSON.parse(c.target.result),E=r.importTokens(p);E.success?i.success(E.message):i.error(E.message)}catch{i.error("文件格式错误")}},d.readAsText(b)}},s.click()},we=()=>{const s=r.cleanExpiredTokens();i.success(`已清理 ${s} 个过期Token`)},ye=()=>{r.gameTokens.forEach(s=>{r.closeWebSocketConnection(s.id)}),i.success("所有连接已断开")},Ue=()=>{q.error({title:"清除所有Token",content:"确定要清除所有Token吗？此操作无法恢复！",positiveText:"确定清除",negativeText:"取消",onPositiveClick:()=>{r.clearAllTokens(),i.success("所有Token已清除")}})},Ce=s=>{if(!s)return"";const e=s.length;return e<=8?s:s.substring(0,4)+"***"+s.substring(e-4)},V=s=>new Date(s).toLocaleString("zh-CN"),J=()=>{F.push("/dashboard")};return We(()=>{r.initTokenStore(),r.hasTokens||(U.value=!0)}),(s,e)=>{const b=w("n-radio-button"),d=w("n-radio-group"),c=w("n-input"),p=w("n-form-item"),E=w("n-collapse-item"),P=w("n-collapse"),_=w("n-button"),O=w("n-form"),G=w("n-dropdown"),xe=w("n-empty"),Se=w("n-modal");return m(),y("div",ts,[n("div",os,[n("div",ls,[n("div",ns,[n("div",rs,[e[17]||(e[17]=n("img",{src:Fe,alt:"XYZW",class:"brand-logo"},null,-1)),t(je)]),e[18]||(e[18]=n("h1",null,"游戏Token管理",-1))])]),!a(r).hasTokens||U.value?(m(),y("div",as,[n("div",is,[n("div",cs,[n("h2",null,[t(a(f),null,{default:o(()=>[t(a(Y))]),_:1}),e[19]||(e[19]=v(" 添加游戏Token ",-1))]),t(d,{value:M.value,"onUpdate:value":e[0]||(e[0]=l=>M.value=l),class:"import-method-tabs",size:"small"},{default:o(()=>[t(b,{value:"manual"},{default:o(()=>[...e[20]||(e[20]=[v(" 手动输入 ",-1)])]),_:1}),t(b,{value:"url"},{default:o(()=>[...e[21]||(e[21]=[v(" URL获取 ",-1)])]),_:1})]),_:1},8,["value"])]),M.value==="manual"?(m(),S(O,{key:0,ref_key:"importFormRef",ref:j,model:k,rules:se,"label-placement":"top",size:"large","show-label":!0},{default:o(()=>[t(p,{label:"游戏角色名称",path:"name","show-label":!0},{default:o(()=>[t(c,{value:k.name,"onUpdate:value":e[1]||(e[1]=l=>k.name=l),placeholder:"例如：主号战士",clearable:""},null,8,["value"])]),_:1}),t(p,{label:"Token字符串",path:"base64Token","show-label":!0},{default:o(()=>[t(c,{value:k.base64Token,"onUpdate:value":e[2]||(e[2]=l=>k.base64Token=l),type:"textarea",rows:3,placeholder:"粘贴Token字符串...",clearable:""},null,8,["value"])]),_:1}),t(P,null,{default:o(()=>[t(E,{title:"角色详情 (可选)",name:"optional"},{default:o(()=>[n("div",us,[t(p,{label:"服务器"},{default:o(()=>[t(c,{value:k.server,"onUpdate:value":e[3]||(e[3]=l=>k.server=l),placeholder:"服务器名称"},null,8,["value"])]),_:1}),t(p,{label:"自定义连接地址"},{default:o(()=>[t(c,{value:k.wsUrl,"onUpdate:value":e[4]||(e[4]=l=>k.wsUrl=l),placeholder:"留空使用默认连接"},null,8,["value"])]),_:1})])]),_:1})]),_:1}),n("div",ds,[t(_,{type:"primary",size:"large",block:"",loading:R.value,onClick:ne},{icon:o(()=>[t(a(f),null,{default:o(()=>[t(a(Q))]),_:1})]),default:o(()=>[e[22]||(e[22]=v(" 添加Token ",-1))]),_:1},8,["loading"]),a(r).hasTokens?(m(),S(_,{key:0,size:"large",block:"",onClick:e[5]||(e[5]=l=>U.value=!1)},{default:o(()=>[...e[23]||(e[23]=[v(" 取消 ",-1)])]),_:1})):T("",!0)])]),_:1},8,["model"])):T("",!0),M.value==="url"?(m(),S(O,{key:1,ref_key:"urlFormRef",ref:A,model:u,rules:te,"label-placement":"top",size:"large"},{default:o(()=>[t(p,{label:"游戏角色名称",path:"name"},{default:o(()=>[t(c,{value:u.name,"onUpdate:value":e[6]||(e[6]=l=>u.name=l),placeholder:"例如：主号战士",clearable:""},null,8,["value"])]),_:1}),t(p,{label:"Token获取地址",path:"url"},{feedback:o(()=>[...e[24]||(e[24]=[n("div",{class:"form-tips"},[n("span",{class:"form-tip"}," 接口应返回包含token字段的JSON数据 "),n("span",{class:"form-tip cors-tip"}," 注意：如果是跨域URL，服务器需要支持CORS，否则会被浏览器阻止 ")],-1)])]),default:o(()=>[t(c,{value:u.url,"onUpdate:value":e[7]||(e[7]=l=>u.url=l),placeholder:"输入API接口地址...",clearable:""},null,8,["value"])]),_:1}),t(P,null,{default:o(()=>[t(E,{title:"角色详情 (可选)",name:"optional"},{default:o(()=>[n("div",ps,[t(p,{label:"服务器"},{default:o(()=>[t(c,{value:u.server,"onUpdate:value":e[8]||(e[8]=l=>u.server=l),placeholder:"服务器名称"},null,8,["value"])]),_:1}),t(p,{label:"自定义连接地址"},{default:o(()=>[t(c,{value:u.wsUrl,"onUpdate:value":e[9]||(e[9]=l=>u.wsUrl=l),placeholder:"留空使用默认连接"},null,8,["value"])]),_:1})])]),_:1})]),_:1}),n("div",ms,[t(_,{type:"primary",size:"large",block:"",loading:R.value,onClick:re},{icon:o(()=>[t(a(f),null,{default:o(()=>[t(a(Q))]),_:1})]),default:o(()=>[e[25]||(e[25]=v(" 获取并添加Token ",-1))]),_:1},8,["loading"]),a(r).hasTokens?(m(),S(_,{key:0,size:"large",block:"",onClick:e[10]||(e[10]=l=>U.value=!1)},{default:o(()=>[...e[26]||(e[26]=[v(" 取消 ",-1)])]),_:1})):T("",!0)])]),_:1},8,["model"])):T("",!0)])])):T("",!0),a(r).hasTokens?(m(),y("div",ks,[n("div",vs,[n("h2",null,"我的Token列表 ("+x(a(r).gameTokens.length)+"个)",1),n("div",fs,[a(r).selectedToken?(m(),S(_,{key:0,type:"success",onClick:J},{icon:o(()=>[t(a(f),null,{default:o(()=>[t(a(He))]),_:1})]),default:o(()=>[e[27]||(e[27]=v(" 返回控制台 ",-1))]),_:1})):T("",!0),U.value?T("",!0):(m(),S(_,{key:1,type:"primary",onClick:e[11]||(e[11]=l=>U.value=!0)},{icon:o(()=>[t(a(f),null,{default:o(()=>[t(a(Y))]),_:1})]),default:o(()=>[e[28]||(e[28]=v(" 添加Token ",-1))]),_:1})),t(G,{options:le,onSelect:he},{default:o(()=>[t(_,null,{icon:o(()=>[t(a(f),null,{default:o(()=>[t(a(qe))]),_:1})]),default:o(()=>[e[29]||(e[29]=v(" 批量操作 ",-1))]),_:1})]),_:1})])]),n("div",_s,[(m(!0),y(Le,null,Me(a(r).gameTokens,l=>(m(),y("div",{key:l.id,class:K(["token-card",{active:l.id===a(r).selectedTokenId,connected:$(l.id)==="connected"}]),onClick:z=>ce(l)},[n("div",hs,[n("div",gs,[n("h3",bs,x(l.name),1),n("div",ws,[l.server?(m(),y("span",ys,x(l.server),1)):T("",!0)])]),n("div",Us,[t(G,{options:pe(l),onSelect:z=>me(z,l)},{default:o(()=>[t(_,{text:""},{icon:o(()=>[t(a(f),null,{default:o(()=>[t(a(Ne))]),_:1})]),_:1})]),_:1},8,["options","onSelect"])])]),n("div",Cs,[n("div",xs,[e[30]||(e[30]=n("span",{class:"token-label"},"Token:",-1)),n("code",Ss,x(Ce(l.token)),1)]),n("div",Rs,[n("div",$s,[n("span",{class:K(["status-dot",$(l.id)])},null,2),n("span",Es,x(ue(l.id)),1)]),n("div",Ws,[l.sourceUrl?(m(),S(_,{key:0,size:"small",type:"default",loading:I.value.has(l.id),onClick:X(z=>D(l),["stop"])},{icon:o(()=>[t(a(f),null,{default:o(()=>[t(a(Z))]),_:1})]),default:o(()=>[e[31]||(e[31]=v(" 刷新 ",-1))]),_:1},8,["loading","onClick"])):T("",!0),t(_,{size:"small",type:$(l.id)==="connected"?"warning":"primary",onClick:X(z=>de(l),["stop"])},{default:o(()=>[v(x($(l.id)==="connected"?"断开":"连接"),1)]),_:2},1032,["type","onClick"])])]),n("div",Ls,[n("div",Ms,[e[32]||(e[32]=n("span",{class:"timestamp-label"},"创建：",-1)),n("span",zs,x(V(l.createdAt)),1)]),n("div",Fs,[e[33]||(e[33]=n("span",{class:"timestamp-label"},"使用：",-1)),n("span",js,x(V(l.lastUsed)),1)])])]),l.id===a(r).selectedTokenId?(m(),y("div",As,[t(_,{type:"primary",block:"",onClick:J},{default:o(()=>[...e[34]||(e[34]=[v(" 开始任务管理 ",-1)])]),_:1})])):T("",!0)],10,Ts))),128))])])):T("",!0),!a(r).hasTokens&&!U.value?(m(),y("div",Bs,[t(xe,{size:"large",description:"还没有导入任何Token"},{icon:o(()=>[t(a(f),{size:"64"},{default:o(()=>[t(a(De))]),_:1})]),_:1})])):T("",!0)]),t(Se,{show:W.value,"onUpdate:show":e[16]||(e[16]=l=>W.value=l),preset:"card",title:"编辑Token",style:{width:"500px"}},{footer:o(()=>[n("div",Is,[t(_,{onClick:e[15]||(e[15]=l=>W.value=!1)},{default:o(()=>[...e[35]||(e[35]=[v(" 取消 ",-1)])]),_:1}),t(_,{type:"primary",onClick:ve},{default:o(()=>[...e[36]||(e[36]=[v(" 保存 ",-1)])]),_:1})])]),default:o(()=>[t(O,{ref_key:"editFormRef",ref:B,model:g,rules:oe,"label-placement":"left","label-width":"80px"},{default:o(()=>[t(p,{label:"名称",path:"name"},{default:o(()=>[t(c,{value:g.name,"onUpdate:value":e[12]||(e[12]=l=>g.name=l)},null,8,["value"])]),_:1}),t(p,{label:"服务器"},{default:o(()=>[t(c,{value:g.server,"onUpdate:value":e[13]||(e[13]=l=>g.server=l)},null,8,["value"])]),_:1}),t(p,{label:"WebSocket地址"},{default:o(()=>[t(c,{value:g.wsUrl,"onUpdate:value":e[14]||(e[14]=l=>g.wsUrl=l)},null,8,["value"])]),_:1})]),_:1},8,["model"])]),_:1},8,["show"])])}}},Xs=Ae(Os,[["__scopeId","data-v-92abbf06"]]);export{Xs as default};
